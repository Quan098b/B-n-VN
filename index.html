<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VN Pin (2D Fullscreen)</title>
  <style>
    html, body { height: 100%; margin: 0; background: #000; overflow: hidden; }
    #stage { position: fixed; inset: 0; }
    #vn {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: contain; /* giữ đúng tỉ lệ ảnh */
      background: #fff;     /* nền trắng đúng như ảnh mẫu */
      user-select: none;
      -webkit-user-drag: none;
    }
    #overlay { position: absolute; inset: 0; pointer-events: none; }
    .pin {
      position: absolute;
      width: 34px; height: 34px;
      transform: translate(-50%, -100%);
      filter: drop-shadow(0 4px 10px rgba(0,0,0,0.45));
    }
  </style>
</head>
<body>
  <div id="stage">
    <img id="vn" src="./VN.png" alt="VN" />
    <div id="overlay"></div>
  </div>

  <script>
    const vn = document.getElementById("vn");
    const overlay = document.getElementById("overlay");

    let lastPos = null; // {xNorm, yNorm}
    const pins = [];

    function getImageRect() {
      // Rect ảnh đang hiển thị thật sự (vì object-fit: contain)
      const r = vn.getBoundingClientRect();

      const naturalW = vn.naturalWidth || 1;
      const naturalH = vn.naturalHeight || 1;
      const arImg = naturalW / naturalH;
      const arBox = r.width / r.height;

      let drawW, drawH, offsetX, offsetY;
      if (arImg > arBox) {
        drawW = r.width;
        drawH = r.width / arImg;
        offsetX = 0;
        offsetY = (r.height - drawH) / 2;
      } else {
        drawH = r.height;
        drawW = r.height * arImg;
        offsetY = 0;
        offsetX = (r.width - drawW) / 2;
      }
      return { left: r.left + offsetX, top: r.top + offsetY, width: drawW, height: drawH };
    }

    function updateLastPos(ev) {
      const ir = getImageRect();
      const x = ev.clientX - ir.left;
      const y = ev.clientY - ir.top;

      if (x < 0 || y < 0 || x > ir.width || y > ir.height) {
        lastPos = null;
        return;
      }
      lastPos = { xNorm: x / ir.width, yNorm: y / ir.height };
    }

    window.addEventListener("mousemove", updateLastPos, { passive: true });

    function drawPinAtNorm(xNorm, yNorm) {
      const ir = getImageRect();
      const vnRect = vn.getBoundingClientRect();
      const offsetX = ir.left - vnRect.left;
      const offsetY = ir.top - vnRect.top;

      const x = ir.width * xNorm;
      const y = ir.height * yNorm;

      const pinEl = document.createElement("img");
      pinEl.className = "pin";
      pinEl.src = "./Gim.png";
      pinEl.alt = "pin";
      pinEl.style.left = (offsetX + x) + "px";
      pinEl.style.top  = (offsetY + y) + "px";

      overlay.appendChild(pinEl);
    }

    function placePin() {
      if (!lastPos) return false;
      pins.push({ xNorm: lastPos.xNorm, yNorm: lastPos.yNorm, createdAt: new Date().toISOString() });
      drawPinAtNorm(lastPos.xNorm, lastPos.yNorm);
      return true;
    }

    function redrawPins() {
      overlay.innerHTML = "";
      for (const p of pins) drawPinAtNorm(p.xNorm, p.yNorm);
    }

    window.addEventListener("resize", redrawPins);

    async function savePins() {
      const payload = {
        savedAt: new Date().toISOString(),
        image: "VN.png",
        pins
      };
      const res = await fetch("/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`Save failed HTTP ${res.status}`);
      return await res.json(); // { ok, file }
    }

    window.addEventListener("keydown", async (e) => {
      if (e.key === "1") {
        e.preventDefault();
        placePin(); // không hiển thị thông báo
      }

      if (e.key === "s" || e.key === "S") {
        e.preventDefault();
        if (pins.length === 0) return;
        try { await savePins(); } catch { /* im lặng */ }
      }
    });

    vn.addEventListener("load", redrawPins);
  </script>
</body>
</html>
